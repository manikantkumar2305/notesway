from motor.motor_asyncio import AsyncIOMotorClient, AsyncIOMotorDatabase
from pymongo import ASCENDING, DESCENDING
from core.config import get_settings

settings = get_settings()

_client: AsyncIOMotorClient | None = None
_db: AsyncIOMotorDatabase | None = None


async def get_db() -> AsyncIOMotorDatabase:
    """FastAPI dependency to provide a database handle."""
    if _db is None:
        raise RuntimeError("Database is not initialized")
    return _db


async def connect_to_mongo() -> None:
    """Initialize MongoDB connection and indexes."""
    global _client, _db
    _client = AsyncIOMotorClient(settings.mongodb_uri)
    _db = _client[settings.mongodb_db]
    await _ensure_indexes()


async def close_mongo() -> None:
    """Close MongoDB connection."""
    if _client:
        _client.close()


async def _ensure_indexes() -> None:
    """Create required indexes for collections."""

    if _db is None:
        return

    # USERS COLLECTION
    users = _db.get_collection("users")
    await users.create_index([("email", ASCENDING)], unique=True, name="idx_users_email")
    await users.create_index([("collegeId", ASCENDING)], name="idx_users_college")
    await users.create_index([("role", ASCENDING)], name="idx_users_role")
    await users.create_index([("createdAt", DESCENDING)], name="idx_users_createdAt")

    # COLLEGES COLLECTION
    colleges = _db.get_collection("colleges")
    await colleges.create_index([("code", ASCENDING)], unique=True, name="idx_college_code")
    await colleges.create_index([("name", ASCENDING)], name="idx_college_name")

    # FILES COLLECTION
    files = _db.get_collection("files")
    await files.create_index([("collegeId", ASCENDING)], name="idx_files_college")
    await files.create_index([("uploaderId", ASCENDING)], name="idx_files_uploader")
    await files.create_index([("keywords", ASCENDING)], name="idx_files_keywords")
    await files.create_index([("subject", ASCENDING)], name="idx_files_subject")
    await files.create_index([("createdAt", DESCENDING)], name="idx_files_createdAt")

    # Full-text search (Atlas supports this)
    try:
        await files.create_index(
            [("title", "text"), ("description", "text"), ("keywords", "text")],
            name="txt_files_search"
        )
    except Exception:
        pass  # If already exists

    # PROFESSOR REQUESTS COLLECTION
    professor_requests = _db.get_collection("professor_requests")
    await professor_requests.create_index([("collegeId", ASCENDING)], name="idx_request_college")
    await professor_requests.create_index([("status", ASCENDING)], name="idx_request_status")
    await professor_requests.create_index([("requestedAt", DESCENDING)], name="idx_request_requestedAt")
